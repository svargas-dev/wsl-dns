#!/bin/bash
# Script to automate VPN fix
# https://learn.microsoft.com/en-us/windows/wsl/troubleshooting#wsl-has-no-network-connectivity-once-connected-to-a-vpn

# Check if the DNS server argument is provided
if [ -z "$1" ]; then
  echo "Usage: $0 <DNS server>"
  exit 1
fi

readonly DNS_SERVER="$1"

# If the WSL VM shutdowns before reverting the resolv.conf will not exist so we need to make a backup
readonly RESOLV_CONF="/etc/resolv.conf"
if [ -f "$RESOLV_CONF" ]; then
  if ! [ -f $RESOLV_CONF.bak ]; then
    sudo cp -p $RESOLV_CONF $RESOLV_CONF.bak
    echo "Backed up $RESOLV_CONF"
  fi
  sudo cp $RESOLV_CONF $RESOLV_CONF.new
  sudo unlink $RESOLV_CONF
  sudo mv $RESOLV_CONF.new $RESOLV_CONF
else
  if [ -f "$RESOLV_CONF.bak" ]; then
    sudo cp -p $RESOLV_CONF.bak $RESOLV_CONF
  else
    echo "Shutdown the WSL VM instance and try again"
    echo "TIP: Make sure you don't have any files open e.g. editor or file explorer"
    exit 1
  fi
fi

## Backup
readonly WSL_CONF="/etc/wsl.conf"
if ! [ -f $WSL_CONF.bak ]; then
  sudo cp -p $WSL_CONF $WSL_CONF.bak
  echo "Backed up $WSL_CONF"
fi
## Edit 
# Change DNS resolve config not already changed
if ! grep -q 'generateResolvConf=false' $WSL_CONF; then
    sudo sh -c 'echo "[network]" >> $WSL_CONF'
    sudo sh -c 'echo "generateResolvConf=false" >> $WSL_CONF'
fi

## Open /etc/resolv.conf and modify it
# Delete this line if present
if grep -q "This file was automatically generated by WSL." /etc/resolv.conf; then
    sudo sed -i '/This file was automatically generated by WSL./d' /etc/resolv.conf
fi
# Update DNS server
sudo sed -i "s/^nameserver .*/nameserver $DNS_SERVER/" /etc/resolv.conf

echo "DNS server updated successfully!"

